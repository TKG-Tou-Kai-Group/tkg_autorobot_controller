# tkg_autorobot_controller

**注：手元のハードウェアに合わせてチューニングしている部分があるので、ご利用の際は慎重に導入してください。**

**注：できるだけ目標角度に追従させるために強めの設定になっているので、十分に注意して利用してください。**

Core 2024 自動ロボットの制御プログラム

## 特徴
- PID制御の代わりに静止摩擦を考慮したLQR制御を導入
- 入力される目標角度の変化をリングバッファでなめらかにすることで、目標角度の振動による制御の発散を抑制
- 機差が予想されるロボットの原点位置をファイルから読み出し
- 砲塔の姿勢をキャリブレーションするツールにより、大まかな初期姿勢を導出可能

- 独自開発のキャッチボールプログラムに向けて、低速回転用ローラ制御プログラムを開発

## 使い方

### キャリブレーションツール

モーターの現在角度とRealSenseのIMUで計測した重力方向により適切なピッチ角原点位置を、旋回方向の両端の限界値から適切なヨー角原点位置をそれぞれ導出するプログラム

注：RealSenseのIMUを使用してピッチ角を調整するので、RealSense用ROS 2パッケージを導入しておくこと

注：ピッチ角はある程度正確に導出できますが、ヨー角はフォトインタラプタの取り付け精度に依存するので精度が甘いです。適宜ファイルを修正してください。

1. 以下のコマンドでキャリブレーションツールを起動
   ```bash
   ros2 launch tkg_autorobot_controller calibrator.launch.py
   ```

2. IMUと現在のモーター角度が正しく読み出されていれば、move rightと表示されるので、砲塔を手で右に回す

3. 旋回限界まで回転させると、次にmove leftと表示されるので、砲塔を手で左に回す

4. 旋回限界まで回転させると自動的にキャリブレーションされた値がlaunchファイルを起動したディレクトリ直下のファイルに格納される

### 砲塔姿勢制御プログラム

基本的な仕様はCoRE_AutoRobot_2024_sampleのturret.pyと同じ

主な調整項目は以下のとおりです。
- リングバッファサイズ(34行目)
  各目標角度の入力に適用するリングバッファのサイズで、小さすぎると目標角度の振動を抑えられずに制御が発散する危険がある

- ヨー軸、ピッチ軸の慣性モーメント(42行目、54行目：LQRコンストラクタの第3引数)
   厳密な値を求めるのが難しいので推定値で記述されている

- ヨー軸、ピッチ軸の最大静止摩擦力(42行目、54行目：LQRコンストラクタの第6引数)
   実機を元に発散しない程度の値に設定している

- ヨー軸、ピッチ軸のStribeck速度(42行目、54行目：LQRコンストラクタの第7引数)
   摩擦の影響を大きく受ける範囲を表す

- ピッチ軸の追加モーメント(124行目：LQR.update()関数の第3引数)
  砲塔の重心の偏りなどで生じる抵抗トルクを角度に比例するとモデル化して実測値ベースで調整している

### 砲塔ローラ制御プログラム

基本的な仕様はCoRE_AutoRobot_2024_sampleのroller.pyと同じ
低速で安定した回転を目指した結果、通常のサンプルプログラムと比べて発射時の減速が大きい傾向にあるので、実戦向きではありません。

## 参考URL
- [電圧入力サーボ系のLQR制御に摩擦を導入してみる](https://qiita.com/hijimasa/items/5e33f03c92c069674baf)
  静止摩擦力を考慮したLQR制御についての説明
